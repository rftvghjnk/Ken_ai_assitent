<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6d28d9;
            --primary-light: #8b5cf6;
            --background: #fff;
            --text: #4c1d95;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, sans-serif;
        }
        
        body {
            background: var(--background);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
            position: relative;
        }
    </style>
</head>
<body>
    <script>
        function initSpeechRecognition(micButton, chatInput) {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Seu navegador n√£o suporta reconhecimento de voz.');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'pt-BR';

            let isListening = false;
            let timeoutId;
            const SILENCE_TIMEOUT = 2000; // 2 segundos de sil√™ncio para parar

            micButton.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                    micButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    micButton.style.background = 'white';
                } else {
                    recognition.start();
                    micButton.innerHTML = '<i class="fas fa-stop"></i>';
                    micButton.style.background = '#ff4444';
                }
            });

            recognition.onresult = (event) => {
                clearTimeout(timeoutId);
                
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                chatInput.value = finalTranscript + interimTranscript;

                // Configura timeout para parar ap√≥s sil√™ncio
                timeoutId = setTimeout(() => {
                    recognition.stop();
                }, SILENCE_TIMEOUT);
            };

            recognition.onend = () => {
                isListening = false;
                micButton.innerHTML = '<i class="fas fa-microphone"></i>';
                micButton.style.background = 'white';
                clearTimeout(timeoutId);
            };

            recognition.onstart = () => {
                isListening = true;
            };

            recognition.onerror = (event) => {
                console.error('Erro no reconhecimento:', event.error);
                isListening = false;
                micButton.innerHTML = '<i class="fas fa-microphone"></i>';
                micButton.style.background = 'white';
            };
        }

        function createCSS() {
            const css = `
                @keyframes slideIn {
                    from { transform: translateY(100px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }

                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.02); }
                    100% { transform: scale(1); }
                }

                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }

                @keyframes slideOut {
                    from { transform: translateY(0); opacity: 1; }
                    to { transform: translateY(-20px); opacity: 0; }
                }

                @keyframes slideUpOut {
                    from { transform: translateY(0); opacity: 1; }
                    to { transform: translateY(-100%); opacity: 0; }
                }

                @keyframes slideUpIn {
                    from { transform: translateY(100%); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }

                @keyframes fadeOut {
                    to {
                        opacity: 0;
                        transform: translateY(-30px);
                        pointer-events: none;
                    }
                }

                @keyframes fadeInUp {
                    from { transform: translateY(20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }

                @keyframes slideUpAndFade {
                    0% { transform: translateY(0); opacity: 1; }
                    100% { transform: translateY(-30px); opacity: 0; visibility: hidden; }
                }

                @keyframes messageIn {
                    from { 
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to { 
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                @keyframes welcomeIn {
                    from { 
                        opacity: 0;
                        transform: translateY(-20px);
                    }
                    to { 
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                @keyframes slideFromBottom {
                    0% { 
                        opacity: 0;
                        transform: translate(-50%, 100vh);
                    }
                    100% { 
                        opacity: 1;
                        transform: translate(-50%, -50%);
                    }
                }

                .knai-floating-window {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 480px;
                    height: 680px;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(165deg, #ffffff, #f8f7ff);
                    border: 1px solid rgba(139, 92, 246, 0.2);
                    border-radius: 16px;
                    box-shadow: 0 12px 30px rgba(139, 92, 246, 0.15);
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    z-index: 9999;
                    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    backdrop-filter: blur(10px);
                }

                .knai-floating-window.knai-initial {
                    animation: slideFromBottom 0.6s ease-out;
                }

                .knai-floating-window.knai-maximized {
                    width: 90%;
                    height: 90%;
                    transform: translate(-50%, -50%) scale(1);
                }

                .knai-floating-window.knai-minimized {
                    height: 45px;
                    transform: translate(-50%, calc(50vh + 315px));
                }

                .knai-floating-window:hover {
                    box-shadow: 0 15px 30px rgba(139, 92, 246, 0.3);
                }

                .knai-floating-window.knai-blurred {
                    opacity: 0.6;
                    transform: scale(0.98);
                    filter: blur(1px);
                }

                .knai-window-header {
                    background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
                    padding: 12px 16px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    cursor: move;
                    user-select: none;
                }

                .knai-window-title {
                    font-family: 'Inter', sans-serif;
                    font-size: 15px;
                    font-weight: 600;
                    color: white;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .knai-window-title i {
                    font-size: 14px;
                }

                .knai-window-controls {
                    display: flex;
                    gap: 8px;
                }

                .knai-window-btn {
                    width: 18px;
                    height: 18px;
                    border-radius: 50%;
                    border: none;
                    cursor: pointer;
                    transition: all 0.3s;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    color: rgba(0, 0, 0, 0.5);
                }

                .knai-window-btn:hover {
                    transform: scale(1.1);
                }

                .knai-window-content {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    background: rgba(255, 255, 255, 0.8);
                }

                .knai-ai-toolbar {
                    display: flex;
                    gap: 8px;
                    padding: 8px;
                    border-bottom: 1px solid rgba(139, 92, 246, 0.1);
                    background: rgba(255, 255, 255, 0.8);
                    align-items: center;
                    justify-content: space-between;
                }

                .knai-ai-status {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 12px;
                    color: #6d28d9;
                    background: rgba(139, 92, 246, 0.1);
                }

                .knai-status-dot {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    transition: all 0.3s ease;
                }

                .knai-status-dot.knai-online {
                    background: #10B981;
                    box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
                }

                .knai-status-dot.knai-warning {
                    background: #F59E0B;
                    box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
                }

                .knai-status-dot.knai-offline {
                    background: #EF4444;
                    box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
                }

                .knai-tool-btn {
                    padding: 6px 12px;
                    border-radius: 6px;
                    border: 1px solid rgba(139, 92, 246, 0.2);
                    background: white;
                    color: #6d28d9;
                    font-size: 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    transition: all 0.2s;
                }

                .knai-tool-btn:hover {
                    background: #f3f0ff;
                    border-color: #8b5cf6;
                }

                .knai-ai-select {
                    padding: 6px 12px;
                    border-radius: 6px;
                    border: 1px solid rgba(139, 92, 246, 0.2);
                    background: white;
                    color: #6d28d9;
                    font-size: 12px;
                    cursor: pointer;
                }

                .knai-chat-container {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    padding: 20px;
                    margin-bottom: 90px;
                    overflow-y: auto;
                    height: calc(100% - 180px);
                    scroll-behavior: smooth;
                }

                .knai-chat-container::-webkit-scrollbar {
                    width: 6px;
                }

                .knai-chat-container::-webkit-scrollbar-track {
                    background: rgba(139, 92, 246, 0.1);
                    border-radius: 10px;
                }

                .knai-chat-container::-webkit-scrollbar-thumb {
                    background: rgba(139, 92, 246, 0.3);
                    border-radius: 10px;
                    border: 2px solid transparent;
                    background-clip: padding-box;
                }

                .knai-chat-container::-webkit-scrollbar-thumb:hover {
                    background: rgba(139, 92, 246, 0.5);
                }

                .knai-message-container {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    width: 85%;
                    margin: 0 auto 16px;
                    padding: 12px 16px;
                    border-radius: 16px;
                    background: linear-gradient(165deg, rgba(255, 255, 255, 0.95), rgba(248, 247, 255, 0.95));
                    border: 1px solid rgba(139, 92, 246, 0.2);
                    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.08);
                    opacity: 0;
                    transform: translateY(20px);
                    animation: messageIn 0.3s ease forwards;
                }

                .knai-welcome-message.knai-hiding {
                    animation: slideUpAndFade 0.5s ease forwards;
                }

                .knai-message-timestamp {
                    display: inline-block;
                    font-size: 11px;
                    color: #6d28d9;
                    background: rgba(139, 92, 246, 0.1);
                    padding: 4px 10px;
                    border-radius: 12px;
                    margin-bottom: 8px;
                    align-self: center;
                }

                .knai-message {
                    position: relative;
                    padding: 12px 16px;
                    border-radius: 12px;
                    font-size: 13px;
                    line-height: 1.5;
                    max-width: 85%;
                }

                .knai-message::before {
                    content: attr(data-who);
                    position: absolute;
                    top: -18px;
                    font-size: 11px;
                    color: #6d28d9;
                    opacity: 0.7;
                }

                .knai-user-message::before {
                    content: 'User';
                    right: 0;
                }

                .knai-ai-message::before {
                    content: 'IA';
                    left: 0;
                }

                .knai-user-message {
                    background: linear-gradient(135deg, #f3f0ff, #ede9fe);
                    margin-left: auto;
                    border-bottom-right-radius: 4px;
                    color: #5b21b6;
                }

                .knai-ai-message {
                    background: linear-gradient(165deg, #ffffff, #f8f7ff);
                    border: 1px solid rgba(139, 92, 246, 0.2);
                    margin-right: auto;
                    border-bottom-left-radius: 4px;
                    color: #4c1d95;
                    font-weight: 800;
                    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.08);
                }

                .knai-ai-message.knai-thinking {
                    font-weight: 500;
                    color: #6d28d9;
                }

                .knai-chat-input-container {
                    position: absolute;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    display: flex;
                    gap: 12px;
                    padding: 12px 16px; /* Reduzido padding */
                    background: white;
                    border: 1px solid rgba(139, 92, 246, 0.15);
                    border-radius: 16px;
                    box-shadow: 0 4px 20px rgba(139, 92, 246, 0.15);
                    backdrop-filter: blur(8px);
                    z-index: 10;
                }

                .knai-chat-input {
                    flex: 1;
                    min-height: 42px; /* Reduzido de 46px */
                    max-height: 100px; /* Reduzido de 120px */
                    padding: 8px 16px; /* Reduzido padding vertical */
                    border: 2px solid rgba(139, 92, 246, 0.2);
                    border-radius: 20px; /* Aumentado para ficar mais arredondado */
                    background: linear-gradient(165deg, #ffffff, #f8f7ff);
                    font-family: 'Inter', sans-serif;
                    font-size: 14px;
                    color: #4c1d95;
                    line-height: 1.4;
                    resize: none;
                    transition: all 0.3s ease;
                }

                .knai-chat-input:focus {
                    outline: none;
                    border-color: #8b5cf6;
                    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
                    background: white;
                }

                .knai-chat-input::placeholder {
                    color: #8b5cf6;
                    opacity: 0.5;
                }

                .knai-input-actions {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    padding: 0 4px;
                }

                .knai-input-action-btn {
                    width: 32px;
                    height: 32px; /* Corrigido para ser quadrado */
                    border-radius: 50%;
                    border: 1px solid rgba(139, 92, 246, 0.2);
                    background: white;
                    color: #6d28d9;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                    font-size: 14px;
                }

                .knai-input-action-btn:hover {
                    background: #f3f0ff;
                    transform: translateY(-2px) scale(1.1);
                    border-color: #8b5cf6;
                    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
                }

                .knai-chat-send-btn {
                    padding: 10px;
                    background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
                    color: white;
                    margin-top: 10px;
                    border: none;
                    border-radius: 50%;
                    width: 42px; /* Ajustado para ser perfeitamente redondo */
                    height: 42px; /* Ajustado para ser perfeitamente redondo */
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.3s;
                    box-shadow: 0 2px 8px rgba(109, 40, 217, 0.2);
                }

                .knai-chat-send-btn:hover {
                    transform: translateY(-2px) rotate(-15deg);
                    box-shadow: 0 4px 12px rgba(109, 40, 217, 0.3);
                }

                .knai-welcome-message {
                    text-align: center;
                    padding: 24px;
                    background: linear-gradient(165deg, #fff, #f0f0ff);
                    border: none;
                    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.1);
                    border-radius: 16px;
                    margin: 20px;
                    transition: all 0.4s ease;
                    animation: welcomeIn 0.5s ease forwards;
                }

                .knai-welcome-message::before {
                    display: none; /* Remove o before do welcome message */
                }

                .knai-welcome-title {
                    font-size: 1.4em;
                    color: #6d28d9;
                    margin-bottom: 20px;
                    font-weight: 600;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 10px;
                }

                .knai-welcome-title i {
                    font-size: 1.2em;
                    background: linear-gradient(135deg, #8b5cf6, #6d28d9);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                }

                .knai-welcome-suggestions {
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                    justify-content: center;
                    margin-top: 16px;
                }

                .knai-suggestion-btn {
                    padding: 10px 20px;
                    border: 1px solid rgba(139, 92, 246, 0.3);
                    border-radius: 25px;
                    background: white;
                    color: #6d28d9;
                    cursor: pointer;
                    transition: all 0.3s;
                    font-size: 14px;
                }

                .knai-suggestion-btn:hover {
                    background: #f3f0ff;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
                }
            `;
            const style = document.createElement('style');
            style.innerHTML = css;
            document.head.appendChild(style);
        }

        function createFloatingWindow() {
            const floatingWindow = document.createElement('div');
            floatingWindow.className = 'knai-floating-window knai-initial';
            
            // Remover classe ap√≥s anima√ß√£o
            floatingWindow.addEventListener('animationend', () => {
                floatingWindow.classList.remove('knai-initial');
            });

            const windowHeader = document.createElement('div');
            windowHeader.className = 'knai-window-header';

            const windowTitle = document.createElement('div');
            windowTitle.className = 'knai-window-title';
            windowTitle.innerHTML = '<i class="fas fa-robot"></i> AI Assistant Pro';

            const windowControls = document.createElement('div');
            windowControls.className = 'knai-window-controls';

            const minimizeBtn = document.createElement('button');
            minimizeBtn.className = 'knai-window-btn knai-minimize-btn';
            minimizeBtn.title = 'Minimizar';
            minimizeBtn.innerHTML = '&minus;';
            minimizeBtn.onclick = (e) => {
                e.stopPropagation();
                floatingWindow.classList.toggle('knai-minimized');
            };

            const maximizeBtn = document.createElement('button');
            maximizeBtn.className = 'knai-window-btn knai-maximize-btn';
            maximizeBtn.title = 'Maximizar';
            maximizeBtn.innerHTML = '&square;';
            maximizeBtn.onclick = (e) => {
                e.stopPropagation();
                floatingWindow.classList.toggle('knai-maximized');
            };

            const closeBtn = document.createElement('button');
            closeBtn.className = 'knai-window-btn knai-close-btn';
            closeBtn.title = 'Fechar';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                document.body.removeChild(floatingWindow);
                document.head.removeChild(document.querySelector('style'));
            };

            windowControls.appendChild(minimizeBtn);
            windowControls.appendChild(maximizeBtn);
            windowControls.appendChild(closeBtn);

            windowHeader.appendChild(windowTitle);
            windowHeader.appendChild(windowControls);

            const windowContent = document.createElement('div');
            windowContent.className = 'knai-window-content';

            // Toolbar principal
            const toolbar = document.createElement('div');
            toolbar.className = 'knai-ai-toolbar';

            const statusContainer = document.createElement('div');
            statusContainer.className = 'knai-ai-status';
            const statusDot = document.createElement('div');
            statusDot.className = 'knai-status-dot knai-online';
            const statusText = document.createElement('span');
            statusText.textContent = 'IA Online';
            statusContainer.appendChild(statusDot);
            statusContainer.appendChild(statusText);

            const toolsGroup = document.createElement('div');
            toolsGroup.style.display = 'flex';
            toolsGroup.style.gap = '8px';

            const aiSelect = document.createElement('select');
            aiSelect.className = 'knai-ai-select';
            ['GPT-3.5', 'GPT-4', 'Claude', 'Gemini'].forEach(model => {
                const option = document.createElement('option');
                option.value = model.toLowerCase();
                option.textContent = model;
                aiSelect.appendChild(option);
            });
            aiSelect.value = 'gemini';

            const clearBtn = document.createElement('button');
            clearBtn.className = 'knai-tool-btn';
            clearBtn.innerHTML = '<i class="fas fa-eraser"></i> Limpar';
            clearBtn.onclick = () => {
                const chatContainer = document.querySelector('.knai-chat-container');
                while (chatContainer.firstChild) {
                    chatContainer.removeChild(chatContainer.firstChild);
                }
                
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = 'knai-welcome-message';
                welcomeMessage.style.opacity = '0';
                welcomeMessage.innerHTML = `
                    <div class="knai-welcome-title">
                        <i class="fas fa-stars"></i>
                        Ol√°! Como posso ajudar voc√™ hoje?
                    </div>
                    <div class="knai-welcome-suggestions">
                        <button class="knai-suggestion-btn">üí° Explicar um conceito</button>
                        <button class="knai-suggestion-btn">üîç Analisar um texto</button>
                        <button class="knai-suggestion-btn">‚ú® Gerar ideias</button>
                    </div>
                `;
                chatContainer.appendChild(welcomeMessage);

                // For√ßar reflow e adicionar anima√ß√£o
                welcomeMessage.offsetHeight;
                welcomeMessage.style.animation = 'welcomeIn 0.5s ease forwards';

                const statusDot = document.querySelector('.knai-status-dot');
                statusDot.className = 'knai-status-dot knai-online';
            };

            toolsGroup.appendChild(aiSelect);
            toolsGroup.appendChild(clearBtn);
            toolbar.appendChild(statusContainer);
            toolbar.appendChild(toolsGroup);

            // Chat container
            const chatContainer = document.createElement('div');
            chatContainer.className = 'knai-chat-container';

            // Prompt inicial
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'knai-message knai-ai-message knai-welcome-message';
            welcomeMessage.innerHTML = `
                <div class="knai-welcome-title">
                    <i class="fas fa-stars"></i>
                    Ol√°! Como posso ajudar voc√™ hoje?
                </div>
                <div class="knai-welcome-suggestions">
                    <button class="knai-suggestion-btn">üí° Explicar um conceito</button>
                    <button class="knai-suggestion-btn">üîç Analisar um texto</button>
                    <button class="knai-suggestion-btn">‚ú® Gerar ideias</button>
                </div>
            `;
            chatContainer.appendChild(welcomeMessage);

            // Chat input container (fixo embaixo)
            const chatInputContainer = document.createElement('div');
            chatInputContainer.className = 'knai-chat-input-container';

            const inputActions = document.createElement('div');
            inputActions.className = 'knai-input-actions';

            ['fa-microphone', 'fa-image', 'fa-file'].forEach(icon => {
                const actionBtn = document.createElement('button');
                actionBtn.className = 'knai-input-action-btn';
                actionBtn.innerHTML = `<i class="fas ${icon}"></i>`;
                inputActions.appendChild(actionBtn);
            });

            const chatInput = document.createElement('textarea');
            chatInput.className = 'knai-chat-input';
            chatInput.placeholder = 'Digite sua mensagem...';

            const micButton = inputActions.firstChild; // Primeiro bot√£o (microfone)
            initSpeechRecognition(micButton, chatInput);

            const chatSendBtn = document.createElement('button');
            chatSendBtn.className = 'knai-chat-send-btn';
            chatSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';

            chatInputContainer.appendChild(inputActions);
            chatInputContainer.appendChild(chatInput);
            chatInputContainer.appendChild(chatSendBtn);

            chatSendBtn.onclick = async () => {
                const pergunta = chatInput.value.trim();
                if (!pergunta) return;

                const statusDot = document.querySelector('.knai-status-dot');
                const welcomeMsg = document.querySelector('.knai-welcome-message');
                
                if (welcomeMsg) {
                    welcomeMsg.classList.add('knai-hiding');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    welcomeMsg.remove();
                }

                // Manter hist√≥rico com scroll
                const containers = chatContainer.querySelectorAll('.knai-message-container');
                containers.forEach(container => {
                    container.style.opacity = '0.7';
                    container.style.transform = 'scale(0.98)';
                });

                // Criar novo container
                const messageContainer = document.createElement('div');
                messageContainer.className = 'knai-message-container';

                const timestamp = document.createElement('div');
                timestamp.className = 'knai-message-timestamp';
                timestamp.textContent = new Date().toLocaleTimeString();
                messageContainer.appendChild(timestamp);

                const userMessage = document.createElement('div');
                userMessage.className = 'knai-message knai-user-message';
                userMessage.textContent = pergunta;
                userMessage.setAttribute('data-who', 'User');
                messageContainer.appendChild(userMessage);

                const aiMessage = document.createElement('div');
                aiMessage.className = 'knai-message knai-ai-message knai-thinking';
                aiMessage.textContent = 'Pensando...';
                aiMessage.setAttribute('data-who', 'IA');
                messageContainer.appendChild(aiMessage);

                chatContainer.appendChild(messageContainer);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                try {
                    aiMessage.innerHTML = `<div class="knai-loading">Carregando resposta...</div>`;

                    const promptTemplate = `Responda usando este formato HTML:
                    <div class="knai-message-content">
                        <div class="knai-message-header">
                            <i class="fas fa-robot"></i> Resposta:
                        </div>
                        <div class="knai-message-body">
                            <h3>{{T√çTULO}}</h3>
                            <div class="knai-message-text">
                                {{RESPOSTA}}
                            </div>
                            {{#if EXEMPLOS}}
                            <div class="knai-examples">
                                <h4><i class="fas fa-lightbulb"></i> Exemplos:</h4>
                                {{EXEMPLOS}}
                            </div>
                            {{/if}}
                        </div>
                    </div>
                    
                    Use:
                    - <pre> para c√≥digos (Use background meio roxo evita  q eles saiam do continer use um limite para eles consigir fica todos drendo dos continers e n√£o saim. com pouco de padding entre lados, e use bordas meio arrendodas 5px)
                    - <p> para par√°grafos
                    - <ul>/<li> para listas
                    - <code> para c√≥digos
                    - <strong> para destaques
                    - Adicione √≠cones Font Awesome quando apropriado
                    
                    Pergunta: ${pergunta}`;

                    const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDg_sGMLqYgNh7VgfOKzKZWUk1i7nWx_Ms', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: promptTemplate }] }]
                        })
                    });

                    const data = await res.json();
                    let resposta = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Desculpe, n√£o consegui processar sua pergunta.';

                    // Adiciona estilos espec√≠ficos para a visualiza√ß√£o
                    aiMessage.innerHTML = `
                        <style>
                            .knai-message-content {
                                padding: 16px;
                                border-radius: 12px;
                                background: white;
                                box-shadow: 0 4px 15px rgba(139, 92, 246, 0.1);
                            }
                            .knai-message-header {
                                color: #6d28d9;
                                font-size: 0.9em;
                                margin-bottom: 12px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            }
                            .knai-message-header i {
                                color: #8b5cf6;
                            }
                            .knai-message-body {
                                color: #4c1d95;
                                line-height: 1.6;
                            }
                            .knai-message-body h3 {
                                color: #6d28d9;
                                margin: 0 0 12px 0;
                                font-size: 1.1em;
                                font-weight: 600;
                            }
                            .knai-message-text {
                                font-size: 0.95em;
                            }
                            .knai-message-text p {
                                margin: 8px 0;
                            }
                            .knai-message-text ul {
                                margin: 8px 0;
                                padding-left: 20px;
                            }
                            .knai-message-text li {
                                margin: 4px 0;
                                position: relative;
                            }
                            .knai-message-text li:before {
                                content: '‚Ä¢';
                                color: #8b5cf6;
                                position: absolute;
                                left: -15px;
                            }
                            .knai-examples {
                                margin-top: 16px;
                                padding-top: 12px;
                                border-top: 1px solid rgba(139, 92, 246, 0.2);
                            }
                            .knai-examples h4 {
                                color: #6d28d9;
                                margin: 0 0 8px 0;
                                font-size: 0.95em;
                                display: flex;
                                align-items: center;
                                gap: 6px;
                            }
                            code {
                                background: #f5f3ff;
                                padding: 2px 6px;
                                border-radius: 4px;
                                color: #5b21b6;
                                font-family: monospace;
                            }
                        </style>
                        ${resposta}
                    `;

                    statusDot.className = 'knai-status-dot knai-online';

                } catch (err) {
                    console.error('Erro na requisi√ß√£o:', err);
                    statusDot.className = 'knai-status-dot knai-warning';
                    aiMessage.classList.remove('knai-thinking');
                    
                    aiMessage.innerHTML = `
                        <div class="knai-error-container">
                            <div class="knai-error-icon">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <div class="knai-error-title">Ops! Algo deu errado</div>
                            <div class="knai-error-message">
                                <p>${err.message || 'Erro ao processar sua solicita√ß√£o.'}</p>
                                <p>Por favor, verifique sua conex√£o e tente novamente.</p>
                            </div>
                            <button class="knai-error-action" onclick="retryRequest()">
                                <i class="fas fa-redo"></i> Tentar novamente
                            </button>
                        </div>
                    `;
                }

                chatInput.value = '';
                chatContainer.scrollTop = chatContainer.scrollHeight;
            };

            function formatarResposta(texto) {
                return texto
                    .split('\n\n')
                    .map(paragrafo => {
                        if (paragrafo.trim().startsWith('```')) {
                            return `<pre>${paragrafo.replace(/```/g, '')}</pre>`;
                        }
                        return `<div class="knai-section">${paragrafo}</div>`;
                    })
                    .join('\n');
            }

            // Montagem final
            windowContent.appendChild(toolbar);
            windowContent.appendChild(chatContainer);
            floatingWindow.appendChild(windowHeader);
            floatingWindow.appendChild(windowContent);
            floatingWindow.appendChild(chatInputContainer);

            document.body.appendChild(floatingWindow);

            let isDragging = false;
            let offsetX, offsetY;

            windowHeader.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - floatingWindow.getBoundingClientRect().left;
                offsetY = e.clientY - floatingWindow.getBoundingClientRect().top;
                floatingWindow.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                // Remove a classe inicial quando come√ßar a arrastar
                floatingWindow.classList.remove('knai-initial');
                
                // Remove transform para permitir posicionamento absoluto
                floatingWindow.style.transform = 'none';
                floatingWindow.style.left = `${e.clientX - offsetX}px`;
                floatingWindow.style.top = `${e.clientY - offsetY}px`;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                floatingWindow.style.cursor = 'grab';
            });

            let clickCount = 0;
            let lastClickTime = 0;
            const TRIPLE_CLICK_DELAY = 2000;

            floatingWindow.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                const currentTime = Date.now();
                if (currentTime - lastClickTime > TRIPLE_CLICK_DELAY) clickCount = 0;
                clickCount++;
                lastClickTime = currentTime;
                if (clickCount >= 3) {
                    floatingWindow.classList.remove('knai-blurred');
                    resetClickCounter();
                }
                setTimeout(() => {
                    if (Date.now() - lastClickTime >= TRIPLE_CLICK_DELAY) resetClickCounter();
                }, TRIPLE_CLICK_DELAY);
            });

            document.addEventListener('mousedown', (e) => {
                if (!floatingWindow.contains(e.target)) {
                    floatingWindow.classList.add('knai-blurred');
                    resetClickCounter();
                }
            });

            function resetClickCounter() {
                clickCount = 0;
                lastClickTime = 0;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            createCSS();
            createFloatingWindow();
        });
    </script>
</body>
</html>
